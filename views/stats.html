<!DOCTYPE html>
<link rel="stylesheet" type="text/css" href="home.css">
<div class="page">
    <html>
        <head>
            <title>Stats</title>
        </head>
        <body>
            <h1 class="uitext">Your Stats</h1>
            <h2 id="chartHeader"></h2>
        </body>
    </html>
</div>
<script>
    class Stats {
        getUserData(user) {
            var requestOptions = {
                method: 'GET',
                redirect: 'follow',
                mode: 'cors'
            };
            return new Promise((resolve, reject) => {
                fetch("https://4wiarmu0k6.execute-api.us-east-1.amazonaws.com/dev/?user=" + user, requestOptions)
                .then(response => response.text())
                .then(result => resolve(JSON.parse(result)))
                .catch(error => console.log('error', error));
            });
        }

        constructor(user) {
            this.user = user;
            this.dataset = this.getUserData(user);
            this.populateObject();
        }

        createGraph(xData, yData, yLabel, overallLabel) {
            let chartOptions = {
                type: 'line',
                data: {
                    datasets: [
                    {
                        label: overallLabel,
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: yData,
                        fill: false,
                    },
                    ],
                },
                options: {
                    title: {
                    display: true,
                    },
                    scales: {
                        xAxes: [
                            {
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Time',
                            },
                            },
                        ],
                        yAxes: [
                            {
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: yLabel,
                            },
                            }
                        ]
                    },
                }
            }
            
            let requestOptions = {
                method: 'GET',
                redirect: 'follow',
                mode: 'cors'
            };

            fetch('https://quickchart.io/chart?c=' + JSON.stringify(chartOptions), requestOptions)
            .then()
            .then(result => {
                let img = document.createElement('img');
                img.src = result.url;
                img.width = 500;
                document.getElementById('chartHeader').append(img);
            })
            .catch(error => console.log('error', error));
        }

        async populateObject() {
            this.dataset = await this.dataset; // ensure the promise has resolved from the constructor
            this.dataset = this.dataset.Items;
            console.log(this.dataset);
            let wpm = [];
            let accuracy = [];
            let i = 0;

            while(i < this.dataset.length) {
                //console.log(JSON.stringify(plays[i]))
                wpm.push(this.dataset[i].WPM);
                accuracy.push(this.dataset[i].Accuracy)
                i++;
            }

            this.createGraph(null, wpm, "WPM", "Your WPM");
            this.createGraph(null, accuracy, "Accuracy", "Your Accuracy");
        }
    }

    let userStats = new Stats("SampleUser");
</script>