<!DOCTYPE html>
<link rel="stylesheet" type="text/css" href="home.css">
<div class="page">
    <html>
        <head>
            <title>Stats</title>
        </head>
        <body>
            <h1 class="uitext">Your Stats</h1>
            <h2 id="wpmChart"></h2>
            <h3 id="accChart"></h3>
        </body>
    </html>
</div>
<script>
    class Stats {
        getUserData(user) {
            var requestOptions = {
                method: 'GET',
                redirect: 'follow',
                mode: 'cors'
            };
            return new Promise((resolve, reject) => {
                fetch("https://4wiarmu0k6.execute-api.us-east-1.amazonaws.com/dev/?user=" + user, requestOptions)
                .then(response => response.text())
                .then(result => resolve(JSON.parse(result)))
                .catch(error => console.log('error', error));
            });
        }

        constructor(user) {
            this.user = user;
            this.dataset = this.getUserData(user);
            this.wpmDaily = null;
            this.wpmWeekly = null;
            this.wpmAll = null;
            this.accDaily = null;
            this.accWeekly = null;
            this.accAll = null;
            this.populateObject();
        }

        createGraph(xData, yData, yLabel, overallLabel) {
            let chartOptions = {
                type: 'line',
                data: {
                    labels: [0,1,2,3],
                    datasets: [
                    {
                        label: overallLabel,
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderColor: 'rgb(255, 99, 132)',
                        data: yData,
                        fill: false,
                    },
                    ],
                },
                options: {
                    title: {
                    display: true,
                    },
                    scales: {
                        xAxes: [
                            {
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: 'Time',
                            },
                            },
                        ],
                        yAxes: [
                            {
                            display: true,
                            scaleLabel: {
                                display: true,
                                labelString: yLabel,
                            },
                            }
                        ]
                    },
                }
            }
            
            let requestOptions = {
                method: 'GET',
                redirect: 'follow',
                mode: 'cors'
            };

            return new Promise((resolve, reject) => {
                fetch('https://quickchart.io/chart?c=' + JSON.stringify(chartOptions), requestOptions)
                .then()
                .then(result => {
                    /*
                    let img = document.createElement('img');
                    img.src = result.url;
                    img.width = 500;
                    document.getElementById('chartHeader').append(img);
                    */
                    resolve(result.url);
                })
                .catch(error => console.log('error', error));
            })
            
        }

        setChart(chart, type) {
            let header = "";
            if(type == "wpm") {
                header = "wpmChart";
                if(document.getElementById(header + "X") != null) {
                    document.getElementById(header + "X").remove();
                }
            }
            if(type == "acc") {
                header = "accChart";
                if(document.getElementById(header + "X") != null) {
                    document.getElementById(header + "X").remove();
                }
            }
            let img = document.createElement('img');
            img.src = chart;
            img.id = header + "X";
            img.width = 500;
            document.getElementById(header).append(img);
        }

        // helper funciton for calling sort on the array in sortByVersion
        versionCompare(a, b) {
            if(Number(a['Version']) > Number(b['Version'])) {
                return 1;
            }
            if(Number(a['Version']) < Number(b['Version'])) {
                return -1;
            }
            return 0;
        }

        sortByVersion(submissions) {
            submissions.sort(this.versionCompare);
        }

        async populateObject() {
            this.dataset = await this.dataset; // ensure the promise has resolved from the constructor
            this.dataset = this.dataset.Items;
            this.sortByVersion(this.dataset);
            console.log(this.dataset);
            let wpm = [];
            let accuracy = [];
            let i = 0;

            while(i < this.dataset.length) {
                wpm.push(this.dataset[i].WPM);
                accuracy.push(this.dataset[i].Accuracy);
                i++;
            }
            console.log(`wpm = ${wpm}`);
            console.log(`acc = ${accuracy}`);

            this.wpmDaily = null;
            this.wpmWeekly = null;
            this.wpmAll = await this.createGraph(null, wpm, "WPM", "Your WPM");
            this.accDaily = null;
            this.accWeekly = null;
            this.accAll = await this.createGraph(null, accuracy, "Accuracy", "Your Accuracy");

            this.setChart(this.wpmAll, "wpm");
            this.setChart(this.accAll, "acc");
        }
    }

    let userStats = new Stats("SampleUser");
</script>