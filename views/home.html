<!DOCTYPE html>
<link rel="stylesheet" type="text/css" href="home.css">
<div class="page">
<html>
<head>
    <title>TypingManiac</title>
</head>
<body>
    <h1 class="uitext">Welcome to TypingManiac!</h1>
    <p class="uitext">Not signed in</p>
    <h2 class="generatedText" id="randomWords">Please type the following statement</h2>
    <h2 class="timer" id="countdown">Time: </h2>
    <h1 class="uitext" id="score">Should not see this!!</h1>
    <div class="content">
    <div class="typeField">
        <input type="text" placeholder="begin typing here..." name="newusername"
        class="textEntry" autofocus id="typeBox" autocomplete="off"
        autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>
    <script type="text/javascript" src="1000-words.js"></script>
    <script>
    let typedWords = 0; // Current words typed
    let correctChars = 0;
    let missedChars = 0;
    let testTime = 60; // seconds for test
    let startedTest = false; // Flag for checking if test was started already or not
    let timer = null; // Timer for user's time
    // Configures initial page
    function configurePage() {
        // Select random words to use from wordbank
        let randomCount = 200; // Pick 200 words in pool
        let shownCount = 8;
        let chosenWords = [];
        let currentWords = []; // Current words only contains next 20 words in bank
        // Hide score element
        document.getElementById("score").style.display = "none";
        for (let i = 0; i < randomCount; i++) {
            chosenWords.push(wordbank[Math.floor(Math.random() * wordbank.length)]);
        }
        for (let i = 0; i < shownCount; i++) {
            if (chosenWords.length == 0) {
                break; // Don't try adding words when currentWords is empty
            }
            currentWords.push(chosenWords.shift()); // Grab 20 words from chosenWords
        }
        document.getElementById("randomWords").innerHTML = currentWords.join(" ");
        document.getElementById("countdown").innerHTML = testTime.toString();
        document.getElementById("typeBox").addEventListener("keyup", (event) => {
            event.preventDefault();
            if (document.getElementById("typeBox").value != 0) {
                if (!startedTest) {
                    startedTest = true;
                    timer = setInterval(countDown, 1000);
                }
            }
            let checkSpace = false;
            if (event.keyCode == 32) {
                let value = document.getElementById("typeBox").value;
                //console.log("inputted word is " + value);
                let words = getWords(value);
                checkSpace = analyzeWords(words, currentWords, chosenWords);
            }
            if (!checkSpace) {
                let word = document.getElementById("typeBox").value;
                let result = analyzeSubstrings(word, currentWords[0]);
                if (event.keyCode != 8) { // Ignore backspace characters in accuracy
                    if (result) correctChars += 1;
                    else missedChars += 1;
                }
            }
        });
    }
    /*
    (Array: String) getWords returns an array of Strings containing words. This
    function splits on the space character in the current input field and
    removes all empty strings from the String Array in the case that multiple
    concurrent space characters are present, or there's a trailing space
    character.
    */
    function getWords(value) {
        return value.split(' ').filter((elem) => elem != '');
    }
    /*
    (Boolean) analyzeWords takes some (Array: String) words from the input field
    on the webpage, (Array: String) currentWords from the on-screen wordbank
    segment, and (Array: String) chosenWords from the total bank of chosen words
    and removes correct words from the currentWords field. When a word from
    currentWords is removed, another is added at the tail of the list from the
    chosenWords bank. Returns true if all of the typed words are correct, and
    false otherwise.
    */
    function analyzeWords(words, currentWords, chosenWords) {
        let phraseLength = words.length;
        // In a perfect world we just compare the first word
        for (let i = 0; i < phraseLength; i++) {
            if (i >= currentWords.length) {
                break;
            }
            if (words[0] === currentWords[0]) {
                document.getElementById("typeBox").style.color = "#FFFFFF";
                currentWords.shift(); // Remove head of current words
                currentWords.push(chosenWords.shift()); // Add next word to chosenWords
                words.shift(); // Remove word at front
                document.getElementById("typeBox").value = words.join(" ");
                document.getElementById("randomWords").innerHTML = currentWords.join(" ");
                document.getElementById("typeBox").placeholder = "";
                typedWords += 1;
            }
        }
        if (phraseLength > words.length) return true;
        return false;
    }
    /*
    (Boolean) analyzeSubstrings takes a (String) word from the input field and
    compares it to the (String) currentWord that should be typed in by the user.
    In the case that word is a substring of currentWord starting from the first
    character in the word, the typeBox element is colored white. Otherwise the
    typeBox element is colored red. Returns true when the substrings are
    matching and false otherwise.
    */
    function analyzeSubstrings(word, currentWord) {
        for (let i = 0; i < word.length; i++) {
            if (i < currentWord.length) {
                if (word[i] !== currentWord[i]) {
                    document.getElementById("typeBox").style.color = "#FF0000";
                    return false;
                } else {
                    document.getElementById("typeBox").style.color = "#FFFFFF";
                }
            } else {
                if (word[currentWord.length] != ' ') {
                    document.getElementById("typeBox").style.color = "#FF0000";
                    return false;
                }
            }
        }
        return true;
    }
    /*
    (void) countDown is a function that runs from a generated interval object
    that counts down every 1 second. When the (int) currentTime for the test
    reaches zero, the test ends and the function displays the WPM and accuracy
    of the typing test.
    */
    function countDown() {
        currentTime = parseInt(document.getElementById("countdown").innerHTML, 10);
        currentTime -= 1; // Decrement time
        if (currentTime <= 0) {
            let WPM = typedWords / (testTime / 60);
            let totalChars = correctChars + missedChars
            let accuracy = Math.floor((correctChars / totalChars) * 100);
            console.log("Accuracy is " + accuracy.toString());
            clearInterval(timer);
            document.getElementById("score").style.display = "block";
            document.getElementById("score").innerHTML = "Congrats! You typed " +
                WPM.toString() + " WPM!";
            document.getElementById("typeBox").style.display = "none";
            insertStats("SampleUser", WPM, accuracy); // Insert data into DynamoDB
        }
        document.getElementById("countdown").innerHTML = currentTime.toString();
    }
    /*
    (void) insertStats takes a (String) user, (Double) speed, (Int) accuracy and
    sends them off to be inserted into DynamoDB as a [User: speed, accuracy]
    record.
    */
    function insertStats(user, speed, accuracy) {
        // instantiate a headers object
        let myHeaders = new Headers();
        // add content type header to object
        myHeaders.append("Content-Type", "application/json");
        // using built in JSON utility package turn object to string and store in a variable
        let raw = JSON.stringify({ "User": user, "WPM": speed, "Accuracy": accuracy });
        // create a JSON object with parameters for API call and store in a variable
        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
        };
        // make API call with parameters and use promises to get response
        fetch("https://4wiarmu0k6.execute-api.us-east-1.amazonaws.com/dev", requestOptions)
        .then(response => response.text())
        .then(result => console.log(JSON.parse(result).body))
        .catch(error => console.log('error', error));
    }
    /*
    (JSON) getUserData performs a GET request to get data from the DynamoDB data
    base for the given (String) user. Returns a JSON object containing records
    for the user.
    */
    async function getUserData(user) {
        var requestOptions = {
            method: 'GET',
            redirect: 'follow',
            mode: 'cors'
        };
        return new Promise((resolve, reject) => {
            fetch("https://4wiarmu0k6.execute-api.us-east-1.amazonaws.com/dev/?user=" + user, requestOptions)
            .then(response => response.text())
            .then(result => resolve(JSON.parse(result)))
            .catch(error => console.log('error', error));
        });
    }
    configurePage(); // Run setup function
    </script>
</body>
</div>
</html>
